<!DOCTYPE html>
<html>
<head>
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-WBZRC7W');</script>
  <!-- End Google Tag Manager -->

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>THE TOURNAMENT | 簡単・便利な無料のトーナメント表作成サービス</title>
  <meta id="description" name="description" content="圧倒的に使いやすい、無料トーナメント表作成ツールの決定版！Webブラウザだけで簡単におしゃれなトーナメント表を作成できます。" />
  <meta id="keywords" name="keywords" content="トーナメント表 作成 無料 トーナメント アプリ ツール フリー ソフト エクセル 作り方" />

  <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
  <meta id="og-title" property="og:title" content="THE TOURNAMENT | 簡単・便利な無料のトーナメント表作成サービス" />
  <meta id="og-type" property="og:type" content="website" />
  <meta id="og-url" property="og:url" content="https://the-tournament.jp/" />
  <meta id="og-image" property="og:image" content="https://app.the-tournament.jp/assets/img/ogp.png" />
  <meta id="og-sitename" property="og:site_name" content="THE TOURNAMENT(ザ・トーナメント)" />
  <meta id="og-description" property="og:description" content="圧倒的に使いやすい、無料トーナメント表作成ツールの決定版！Webブラウザだけで簡単におしゃれなトーナメント表を作成できます。" />
  <meta id="og-locale" property="og:locale" content="ja_JP" />
  <meta property="fb:app_id" content="141909199806953" />
  <meta id="twitter-card" name="twitter:card" content="summary" />
  <meta id="twitter-site" name="twitter:site" content="@tournament_jp" />
  <meta id="robots" name="robots" content="" />
  <link id="canonical" rel="canonical" href="https://the-tournament.jp/" />
  <link id="amp-url" rel="amphtml" />

  <link rel="alternate" type="application/rss+xml" href="https://the-tournament.jp/feed" title="RSS2.0" />

  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.2.3/dist/semantic.min.css">
  <link rel="stylesheet" type="text/css" href="/css/tournament.css">

  <script src="//j.wovn.io/1" data-wovnio="key=We0CPb" async></script>
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WBZRC7W"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <header></header>
  <flash></flash>
  <div style="min-height:calc(100vh - 260px);">
    <content></content>
    <dimmer></dimmer>
  </div>
  <footer></footer>


  <script src="/tags/layouts/dimmer.tag" type="riot/tag"></script>
  <script src="/tags/layouts/flash.tag" type="riot/tag"></script>
  <script src="/tags/layouts/footer.tag" type="riot/tag"></script>
  <script src="/tags/layouts/header.tag" type="riot/tag"></script>
  <script src="/tags/pages/tournaments/edit/country-select.tag" type="riot/tag"></script>
  <script src="/tags/pages/tournaments/edit/bracket-header.tag" type="riot/tag"></script>
  <script src="/tags/pages/tournaments/edit/edit.tag" type="riot/tag"></script>
  <script src="/tags/pages/tournaments/edit/match-modal.tag" type="riot/tag"></script>
  <script src="/tags/pages/tournaments/edit/menu.tag" type="riot/tag"></script>
  <script src="/tags/pages/tournaments/edit/settings.tag" type="riot/tag"></script>
  <script src="/tags/pages/tournaments/edit/share.tag" type="riot/tag"></script>
  <script src="/tags/pages/tournaments/edit/team-modal.tag" type="riot/tag"></script>
  <script src="/tags/pages/tournaments/edit/teams.tag" type="riot/tag"></script>
  <script src="/tags/pages/tournaments/index.tag" type="riot/tag"></script>
  <script src="/tags/pages/tournaments/show.tag" type="riot/tag"></script>
  <script src="/tags/pages/auth.tag" type="riot/tag"></script>
  <script src="/tags/pages/mypage.tag" type="riot/tag"></script>
  <script src="/tags/pages/password.tag" type="riot/tag"></script>
  <script src="/tags/pages/top.tag" type="riot/tag"></script>
  <script src="/tags/shared/bracket.tag" type="riot/tag"></script>
  <script src="/tags/shared/double-bracket.tag" type="riot/tag"></script>
  <script src="/tags/shared/breadcrumb.tag" type="riot/tag"></script>
  <script src="/tags/shared/sns-share.tag" type="riot/tag"></script>
  <script src="/tags/shared/raw.tag" type="riot/tag"></script>
  <script src="/tags/shared/results.tag" type="riot/tag"></script>
  <script src="/tags/shared/tournament-list.tag" type="riot/tag"></script>


  <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/riot@3.8/riot+compiler.min.js"></script>
  <script src="https://cdn.jsdelivr.net/riot-route/3.0.1/route.min.js"></script>
  <script src="/js/html2canvas.min.js" async></script>
  <script>
    /***********************************************
    * Firebase Initialization
    ***********************************************/
    if(location.hostname=='the-tournament.jp') {
      /* Production */
      const ENV = 'production'
      var config = {
        apiKey: "AIzaSyBpJ93PBOR6cr-PeM74vYiylQcq1QpcWFI",
        authDomain: "tournament-7e3b7.firebaseapp.com",
        databaseURL: "https://tournament-7e3b7.firebaseio.com",
        projectId: "tournament-7e3b7",
        storageBucket: "tournament-7e3b7.appspot.com",
        messagingSenderId: "670551703759"
      }
    }else {
      /* Staging */
      const ENV = 'staging'
      var config = {
        apiKey: "AIzaSyB6fOdlYBhEmSD-VoyiO1t88DxBZHlnhUI",
        authDomain: "tournament-staging.firebaseapp.com",
        databaseURL: "https://tournament-staging.firebaseio.com",
        projectId: "tournament-staging",
        storageBucket: "tournament-staging.appspot.com",
        messagingSenderId: "327887248230"
      }
    }
    firebase.initializeApp(config)
    var db = firebase.firestore()
    var obs = riot.observable()


    /***********************************************
    * Mixin
    ***********************************************/
    var tournamentMixin = {
      /* チーム数増減 */
      addTeams: function(tournament, roundCountDiff, withTeamName) {
        // add teams
        var oldTeamsCount = Object.keys(tournament.teams).length
        var newTeamsCount = oldTeamsCount * Math.pow(2,roundCountDiff)
        for(var i = oldTeamsCount + 1; i <= newTeamsCount; i++ ) {
          var name = (withTeamName) ? "Player"+i : ''
          tournament.teams.push({name: name})
        }

        // add results
        var oldRoundNum = Math.ceil(Math.LOG2E * Math.log(oldTeamsCount))  //=> return 3 rounds for 8 players (2**3=8)
        // 元々存在していたラウンドに、試合数が足りない分を追加
        for(var i = 1; i<= oldRoundNum; i++) {
          var oldMatchCount = oldTeamsCount / Math.pow(2,i)     //=> return 4 mathes for 8 players 1st round
          var newMatchCount = newTeamsCount / Math.pow(2,i) //=> return 8 matches for new 16 players 1st round

          for(var j = oldMatchCount + 1; j <= newMatchCount; j++) {
            tournament.results[i-1][j-1] = {"score": {0:null, 1:null}, "comment": null, "winner": null}
          }
        }
        // 新たに追加されるラウンドの試合を追加（決勝ラウンド除く）
        for(var i = oldRoundNum + 1; i<= oldRoundNum + roundCountDiff - 1; i++) {
          var newMatchCount = newTeamsCount / Math.pow(2,i) //=> return 8 matches for new 16 players 1st round

          tournament.results[i-1] = {}
          for(var j = 1; j <= newMatchCount; j++) {
            tournament.results[i-1][j-1] = {"score": {0:null, 1:null}, "comment": null, "winner": null}
          }
        }
        // 決勝ラウンド追加（決勝・3位決定戦）
        tournament.results[oldRoundNum+roundCountDiff-1] = [{"score": {0:null, 1:null}, "comment": null, "winner": null}, {"score": {0:null, 1:null}, "comment": null, "winner": null}]
      },


      /* 勝ち上がりチーム情報の取得 */
      getTeamIndex: function(tournament, roundIndex, matchIndex, teamOrder) {
        var isConsolation = (roundIndex == Object.keys(tournament.results).length - 1) && (matchIndex == 1)
        // 1回戦
        if(roundIndex==0) {
          teamIndex = ( matchIndex * 2 ) + teamOrder
          return teamIndex
        // 2回戦以降
        }else {
          prevMatchIndex = (isConsolation) ? teamOrder : ( matchIndex * 2 ) + teamOrder
          prevResult = tournament.results[roundIndex-1][prevMatchIndex]
          // 前の試合が終了している場合：遡って勝利チームを取得
          if(prevResult['winner']!=null) {
            prevWinnerIndex = (isConsolation) ? 1 - prevResult['winner'] : prevResult['winner']
            return tournamentMixin.getTeamIndex(tournament, roundIndex-1, prevMatchIndex, prevWinnerIndex)
          // 前の試合が終了していない場合
          }else {
            return null
          }
        }
      },


      removeTeams: function(tournament, roundCountDiff) {
        // remove teams
        var oldTeamsCount = Object.keys(tournament.teams).length
        var newTeamsCount = oldTeamsCount / Math.pow(2,roundCountDiff)
        tournament.teams.splice(newTeamsCount, oldTeamsCount-newTeamsCount)

        // remove results
        var oldRoundNum = Math.ceil(Math.LOG2E * Math.log(oldTeamsCount))  //=> return 3 rounds for 8 players (2**3=8)
        var newRoundNum = oldRoundNum - roundCountDiff

        // 残すラウンドの不要になる試合を削除
        for(var i = 1; i<= newRoundNum; i++) {
          var newMatchCount = Math.max(newTeamsCount / Math.pow(2,i), 2) //=> return 4 matches for 16→8 players 1st round
          tournament.results[i-1] = tournament.results[i-1].splice(0, newMatchCount)
        }
        // 3位決定戦をリセット
        tournament.results[newRoundNum-1][1] = {"score": {0:null, 1:null}, "comment": null, "winner": null}
        // 不要になるラウンドをまるごと削除
        for(var i = newRoundNum+1; i<=oldRoundNum; i++) {
          delete tournament.results[i-1]
        }
      },


      setMetatags: function(meta) {
        let title = (meta && meta.title) ? meta.title + ' | THE TOURNAMENT' : 'THE TOURNAMENT | 簡単・便利な無料のトーナメント表作成サービス'
        let description = (meta && meta.description) ? meta.description : "圧倒的に使いやすい、無料トーナメント表作成ツールの決定版！Webブラウザだけで簡単におしゃれなトーナメント表を作成できます。"
        let keywords = 'トーナメント表,作成,THE TOURNAMENT,トーナメント'
        if(meta && meta.keyword) {
          keywords = keywords + ',' + meta.keyword
        }
        let noindex = (meta && meta.noindex) ? 'noindex' : ''

        document.title = title
        document.getElementById('description').setAttribute('content', description)
        document.getElementById('keywords').setAttribute('content', keywords)
        document.getElementById('og-title').setAttribute('content', title)
        document.getElementById('og-description').setAttribute('content', description)
        document.getElementById('og-url').setAttribute('content', location.href)
        document.getElementById('robots').setAttribute('content', noindex)

        if(meta && meta.ampURL) {
          document.getElementById('amp-url').setAttribute('href', meta.ampURL)
        }
      },


      updateByeGames: function(tournament) {
        for(var roundIndex = 0; roundIndex < Object.keys(tournament.results).length; roundIndex++) {
          for(var matchIndex = 0; matchIndex < Object.keys(tournament.results[roundIndex]).length; matchIndex++) {
            // FIXME: ３位決定戦はとりあえずスキップ
            if(roundIndex==Object.keys(tournament.results).length-1 && matchIndex==1) { continue }

            // １回戦は参加者名からbye/skipを判定
            if(roundIndex==0) {
              var teams = [
                tournament.teams[matchIndex*2],
                tournament.teams[matchIndex*2+1],
              ]
              if(teams[0]['name']=='' && teams[1]['name']=='') {
                tournament.results[roundIndex][matchIndex]['bye'] = true
                tournament.results[roundIndex][matchIndex]['winner'] = null
              }else if(teams[0]['name']=='') {
                tournament.results[roundIndex][matchIndex]['bye'] = true
                tournament.results[roundIndex][matchIndex]['winner'] = 1
              }else if(teams[1]['name']=='') {
                tournament.results[roundIndex][matchIndex]['bye'] = true
                tournament.results[roundIndex][matchIndex]['winner'] = 0
              }else {
                tournament.results[roundIndex][matchIndex]['bye'] = false
              }
            // 2回戦以降は前のラウンドの試合結果から判定
            }else {
              var prevResults = [
                tournament.results[roundIndex-1][matchIndex*2],
                tournament.results[roundIndex-1][matchIndex*2+1]
              ]
              var prevSkip_0 = prevResults[0]['bye'] && prevResults[0]['winner']==null
              var prevSkip_1 = prevResults[1]['bye'] && prevResults[1]['winner']==null

              if(prevSkip_0 && prevSkip_1) {
                tournament.results[roundIndex][matchIndex]['bye'] = true
                tournament.results[roundIndex][matchIndex]['winner'] = null
              }else if(prevSkip_0) {
                tournament.results[roundIndex][matchIndex]['bye'] = true
                tournament.results[roundIndex][matchIndex]['winner'] = 1
              }else if(prevSkip_1) {
                tournament.results[roundIndex][matchIndex]['bye'] = true
                tournament.results[roundIndex][matchIndex]['winner'] = 0
              }else {
                tournament.results[roundIndex][matchIndex]['bye'] = false
              }
            }
          }
        }
        return tournament
      }
    }
    riot.mixin(tournamentMixin)



    /***********************************************
    * Routing
    ***********************************************/
    route.base('/')
    riot.mount('header')
    riot.mount('footer')
    riot.mount('flash')
    riot.mount('dimmer')

    route('/', function() {
      riot.mount('content', 'top')
    })
    route('/signin', function(){
      riot.mount('content', 'auth')
    })
    route('/password', function(){
      riot.mount('content', 'password')
    })
    route('/mypage', function(){
      riot.mount('content', 'mypage')
    })
    route('/tournaments', function() {
      riot.mount('content', 'index')
    })
    route('/tournaments/*/edit', function(id){
      riot.mount('content', 'edit', {id: id})
    })
    route('/tournaments/*', function(id){
      riot.mount('content', 'show', {id: id})
    })
    route('/tournaments/*/*', function(id){
      riot.mount('content', 'show', {id: id})
    })
    route('/auth..', function(){
      obs.trigger("dimmerChanged", 'active')
      var q = route.query()
      if(q.mode == 'resetPassword') {
        firebase.auth().verifyPasswordResetCode(q.oobCode).then(function(email) {
          var newPassword = Math.random().toString(36).slice(-12)
          firebase.auth().confirmPasswordReset(q.oobCode, newPassword).then(function(){
            firebase.auth().signInWithEmailAndPassword(email, newPassword)
            obs.trigger("flashChanged", {type:'success',text:'ログインしました'})
          })
        }).catch(function(error){
          obs.trigger("flashChanged", {type:'error',text:'ログインに失敗しました..'})
        }).then(function(){
          obs.trigger("dimmerChanged", '')
          route('/')
        })
      }
    })
    route('/..', function() {
      route('/', '', true)
    })

    route.start(true)
  </script>
</body>
</html>
